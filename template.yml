AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  SuggestionsDiscordWebhook:
    Type: AWS::SSM::Parameter::Value<String>
    Default: 'SuggestionsDiscordWebhook'

Globals:
  Function:
    Runtime: go1.x
    Handler: lambda
    Timeout: 10
    Environment:
      Variables:
        SUBMISSIONS_DATABASE: !Ref SubmissionsDatabase
        SUGGESTIONS_WEBHOOK: !Ref SuggestionsDiscordWebhook

Resources:
  SubmissionsApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: '$default'
      Auth:
        DefaultAuthorizer: Default
        Authorizers:
          Default:
            AuthorizerPayloadFormatVersion: 1
            FunctionArn: !Ref AuthorizerFunction

  SubmissionsDatabase:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: UUID
          AttributeType: S
        - AttributeName: OwnerID
          AttributeType: S
        - AttributeName: CreatedAt
          AttributeType: S
      KeySchema:
        - AttributeName: UUID
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_IMAGE

      GlobalSecondaryIndexes:
        - IndexName: ownerid-createdat-index
          KeySchema:
            - AttributeName: OwnerID
              KeyType: HASH
            - AttributeName: CreatedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  AuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: cmd/authorizer/

  CreateSubmission:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: cmd/create_submission/
      Policies: AmazonDynamoDBFullAccess
      Events:
        CreateHandler:
          Type: HttpApi
          Properties:
            ApiId: !Ref SubmissionsApi
            Path: '/submissions'
            Method: POST

  IndexSubmissions:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: cmd/index_submissions/
      Policies: AmazonDynamoDBFullAccess
      Events:
        IndexHandler:
          Type: HttpApi
          Properties:
            ApiId: !Ref SubmissionsApi
            Path: '/submissions'
            Method: GET

  GetSubmission:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: cmd/get_submission/
      Policies: AmazonDynamoDBFullAccess
      Events:
        GetHandler:
          Type: HttpApi
          Properties:
            ApiId: !Ref SubmissionsApi
            Path: '/submissions/{uuid}'
            Method: GET
            Auth:
              Authorizer: NONE

  SendSubmission:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: cmd/send_submission/
      Policies: AmazonDynamoDBFullAccess
      Events:
        SendHandler:
          Type: HttpApi
          Properties:
            ApiId: !Ref SubmissionsApi
            Path: '/submissions/{uuid}/send'
            Method: POST
            Auth:
              Authorizer: NONE

  DeleteSubmission:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: cmd/delete_submission/
      Policies: AmazonDynamoDBFullAccess
      Events:
        DeleteHandler:
          Type: HttpApi
          Properties:
            ApiId: !Ref SubmissionsApi
            Path: '/submissions/{uuid}'
            Method: DELETE
            Auth:
              Authorizer: NONE

